{% extends 'base.html' %}

{% load static %}
{% load filters_tags %}
{% load widget_tweaks %}
{% load humanize %}

{% block title %} {{ meta_object.master_name }} {% endblock %}

{% block style %}
    <link rel="stylesheet" href="{% static "css/source_style.css" %}" />
{% endblock %}

{% block content %}

    <ul class="nav nav-tabs" id="myTab">
        {% for survey in surveys %}

            {% define sources|is_in_survey:survey as source %}

            {% if survey.name == meta_object.master_survey %}
                {% define "active" as status %}
            {% else %}
                {% define "" as status %}
            {% endif %}

            <li class="nav-item">
            {% if survey.name == 9 %}
                {% define "Survey1234" as tab_name %}
                {% define "" as number %}
            {% else %}
                {% define "Survey" as tab_name %}
                {% define survey.name|to_str as number %}
            {% endif %}

            {% if source %}
                {% comment %} For mark of 'master' sources {% endcomment %}
                {% if  status == "active" %}
                    <a href="#survey{{ survey.name }}" class="nav-link {{ status }}" data-toggle="tab">{{ tab_name }}{{ number }}
                        <span class="badge">M</span>
                    </a>
                {% else %}
                    <a href="#survey{{ survey.name }}" class="nav-link {{ status }}" data-toggle="tab">{{ tab_name }}{{ number }}</a>
                {% endif %}
            {% endif %}
            </li>

        {% endfor %}
        {% comment %} For showing meta objects from same MetaGroup {% endcomment %}
        <li class="nav-item">
            <a href="#meta_group" class="nav-link" data-toggle="tab">Group</a>
        </li>

    </ul>

    <div class="tab-content">
        {% for survey in surveys %}

            {% define sources|is_in_survey:survey as source %}

            {% if survey.name == meta_object.master_survey %}
                {% define "fade show active" as status %}
            {% else %}
                {% define "fade" as status %}
            {% endif %}

            <div class="tab-pane {{ status }}" id="survey{{ survey.name }}">

                {%  comment %} Source X-ray images {% endcomment %}
                <div id = "container" >
                    {% include 'includes/xray_images.html' %}
                </div>

                {%  comment %} Source table with head:value(parameters) {% endcomment %}
                <div class="table_source">
                    <table class="table table-bordered table-responsive-md">
                      <thead class="thead-dark">
                        <tr>
                            <th>Head</th>
                           <th>Value</th>
                        </tr>
                      </thead>
                      <tbody>

                        {% for field,value in source %}
                            <tr>
                                <td>{{ field }}</td>
                                <td>{{ value }}</td>
                            </tr>
                        {% endfor %}
                        {% for field,value in meta_object %}
                            <tr>
                                <td>Meta_{{ field }}</td>
                                <td>{{ value }}</td>
                            </tr>
                        {% endfor %}

                      </tbody>
                    </table>
                </div>

                {%  comment %} 'Master' form for xray source {% endcomment %}
                {% if user.is_superuser %}
                    <form id="master_form" method="post" novalidate>
                        {% csrf_token %}
                        <input id="mas_field_id" type="hidden" name="source_id" value={{ source.pk }}>
                        <button type="submit" class="btn btn-outline-primary btn-md" value="button" name="master">
                            Master </button>
                    </form>
                {% endif %}

                {%  comment %} TODO: comment form in cycle! {% endcomment %}
                {%  comment %} Comment form {% endcomment %}
                <div class = "comment_section">
                    {%  comment %} add 'novalidate' when learn why widget_tweaks doesnt show errors {% endcomment %}
                    <form id="comment_form" method="post">
                        {% csrf_token %}
                        {% include 'includes/form.html' %}
                        <button type="submit" class="btn btn-success" value="button" name="x_comment">Create/Edit</button>
                    </form>
                </div>

            </div>

        {% endfor %}

        {% comment %} For showing meta objects from same MetaGroup {% endcomment %}
        <div class="tab-pane fade" id="meta_group">
            {%  comment %} Table with meta objects from same MetaGroup {% endcomment %}
            <div class="meta_group_table">
                <table class="table table-bordered table-responsive-md">
                  <thead class="thead-dark">
                    <tr>
                        <th>master_ind</th>
                        <th>master_name</th>
                        <th>master_survey</th>
                        <th>ID e1</th>
                        <th>ID e2</th>
                        <th>ID e3</th>
                        <th>ID e4</th>
                        <th>ID e1234</th>
                    </tr>
                  </thead>
                  <tbody>

                    {% for meta_object in meta_group.meta_objects.all %}
                        <a>
                            <td>{{ meta_object.master_ind }}</td>
                            {% if meta_object.primary_object %}
                                <td><a href="{% url 'source' meta_object.pk %}">
                                    <span class="badge">P</span>{{ meta_object.master_name }}</a></td>
                            {% else %}
                                <td><a href="{% url 'source' meta_object.pk %}">{{ meta_object.master_name }}</a></td>
                            {% endif %}
                            <td>{{ meta_object.master_survey }}</td>
                            <td>{{ meta_object.ID_e1 }}</td>
                            <td>{{ meta_object.ID_e2 }}</td>
                            <td>{{ meta_object.ID_e3 }}</td>
                            <td>{{ meta_object.ID_e4 }}</td>
                            <td>{{ meta_object.ID_e1234 }}</td>
                        </tr>
                    {% endfor %}

                  </tbody>
                </table>
            </div>
        </div>

        {%  comment %} List of comments for this source {% endcomment %}
        <div class="comments" style="width: 30rem;">
            {% with meta_object.comments.all as comments %}
                {% include 'includes/list_comments.html' %}
            {% endwith %}
        </div>

    </div>

{% endblock %}